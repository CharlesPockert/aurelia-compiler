{"version":3,"sources":["index.js"],"names":[],"mappings":";;;;;;;;;;gCAAyF,mBAAmB;;oCAChF,wBAAwB;;6BAChB,gBAAgB;;iCACtB,oBAAoB;;IAOrC,QAAQ;eAAR,QAAQ;;WACN,kBAAG;AAAC,aAAO,sMAAkF,CAAA;KAAC;;;AAChG,WAFA,QAAQ,CAEP,YAAY,EAAE,iBAAiB,EAAC,UAAU,EAAE,SAAS,EAAE,SAAS,EAAC,MAAM,EAAE;0BAF1E,QAAQ;;AAGjB,QAAI,CAAC,YAAY,GAAG,YAAY,CAAC;AACjC,QAAI,CAAC,UAAU,GAAG,UAAU,CAAC;AAC7B,QAAI,CAAC,iBAAiB,GAAG,iBAAiB,CAAC;AAC3C,QAAI,CAAC,SAAS,GAAG,SAAS,CAAC;AAC3B,QAAI,CAAC,SAAS,GAAG,SAAS,CAAC;AAC3B,QAAI,CAAC,MAAM,GAAG,MAAM,CAAC;GACtB;;eATU,QAAQ;;WAgBX,kBAAC,SAAS,EAAC,IAAI,EAAC,WAAW,EAAC;;AAElC,UAAI,OAAO,GAAG,SAAS,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC;AACrC,UAAI,QAAQ,GAAG,OAAO,CAAC,eAAe,CAAC;;AAGvC,UAAG,CAAC,QAAQ,CAAC,gBAAgB,EAAE;AAC7B,YAAI,KAAK,GAAG,OAAO,CAAC,SAAS,CAAC;AAC9B,YAAG,WAAW,EAAE,KAAK,GAAG,WAAW,CAAC,OAAO,EAAC,OAAO,CAAC,SAAS,CAAC,CAAC;AAC/D,gBAAQ,CAAC,gBAAgB,GAAG,IAAI,CAAC,cAAc,CAAC,KAAK,CAAC,CAAC;OAGxD;;AAED,aAAO,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,CAAC,IAAI,CAAC,UAAA,KAAK,EAAE;AACzC,YAAI,QAAQ,GAAG,KAAK,CAAC,QAAQ,CAAC;;AAE9B,YAAI,IAAI,GAAG,EAAE,CAAC;AACd,aAAI,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,QAAQ,CAAC,OAAO,CAAC,QAAQ,CAAC,MAAM,EAAE,CAAC,GAAG,CAAC,EAAE,CAAC,EAAE,EAAC;AAC9D,cAAI,KAAK,GAAG,QAAQ,CAAC,OAAO,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC;AACzC,cAAG,KAAK,EAAE,IAAI,IAAI,KAAK,CAAC,SAAS,CAAC;SACnC;;AAED,YAAG,WAAW,EAAE,IAAI,GAAG,WAAW,CAAC,OAAO,EAAC,IAAI,CAAC,CAAC;;AAGjD,eAAO,CAAC,SAAS,GAAG,IAAI,CAAC;;AAEzB,eAAO,QAAQ,CAAC;OACjB,CAAC,CAAC;KACJ;;;WAQa,wBAAC,OAAO,EAAC;AAErB,UAAI,QAAQ,GAAG,QAAQ,CAAC,sBAAsB,EAAE,CAAC;;AAEjD,UAAI,CAAC,GAAG,QAAQ,CAAC,aAAa,CAAC,KAAK,CAAC,CAAC;AACtC,OAAC,CAAC,SAAS,GAAG,AAAC,OAAO,YAAY,WAAW,GAAG,OAAO,CAAC,SAAS,GAAG,OAAO,CAAC;;AAE5E,UAAI,YAAY,GAAG,CAAC,CAAC,UAAU;UAAE,WAAW,CAAC;AAC7C,aAAM,YAAY,EAAC;AACjB,mBAAW,GAAG,YAAY,CAAC,WAAW,CAAC;AACvC,gBAAO,YAAY,CAAC,QAAQ;AAC1B,eAAK,CAAC;AACJ,oBAAQ,CAAC,WAAW,CAAC,YAAY,CAAC,CAAC;AACnC,kBAAM;AAAA,SACT;AACD,oBAAY,GAAG,WAAW,CAAC;OAC5B;;AAED,aAAO,QAAQ,CAAC;KACjB;;;WAUc,yBAAC,SAAS,EAAC,GAAG,EAAC;AAE5B,UAAI,OAAO,GAAG,SAAS,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC;;AAErC,UAAI,QAAQ,GAAG,OAAO,CAAC,eAAe,CAAC;;AAGvC,UAAG,CAAC,QAAQ,EAAE,OAAO;;AAErB,UAAG,QAAQ,CAAC,WAAW,EAAE,OAAO;;AAEhC,cAAQ,CAAC,UAAU,GAAG,KAAK,CAAC;;AAG5B,UAAI,QAAQ,GAAG,SAAS,CAAC,GAAG,4BAAU,CAAC;AACvC,UAAI,SAAS,GAAG,SAAS,CAAC,GAAG,iCAAe,CAAC;;AAK7C,UAAI,QAAQ,GAAG,IAAI,CAAC,cAAc,CAAC,OAAO,CAAC,CAAC;;AAG5C,UAAI,OAAO,GAAG,QAAQ,CAAC,gBAAgB,CAAC,YAAY,CAAC,CAAC;AACtD,WAAI,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,OAAO,CAAC,MAAM,EAAE,CAAC,GAAG,CAAC,EAAE,CAAC,EAAE,EAAC;AAC5C,YAAI,MAAM,GAAG,OAAO,CAAC,CAAC,CAAC,CAAC;AACxB,cAAM,CAAC,SAAS,CAAC,MAAM,CAAC,WAAW,CAAC,CAAC;OACtC;;AAGD,UAAI,WAAW,GAAG,QAAQ,CAAC,QAAQ,CAAC,WAAW,GAAG,IAAI,CAAC,YAAY,CAAC,OAAO,CAAC,QAAQ,EAAE,SAAS,CAAC,CAAC;;AAGjG,aAAO,CAAC,SAAS,GAAG,EAAE,CAAC;;AAGvB,UAAI,IAAI,GAAG,WAAW,CAAC,MAAM,CAAC,SAAS,EAAC,GAAG,IAAE,QAAQ,CAAC,gBAAgB,CAAC,CAAC;AACxE,cAAQ,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC;AACnB,cAAQ,CAAC,QAAQ,EAAE,CAAC;;AAGpB,cAAQ,CAAC,IAAI,GAAG,IAAI,CAAC;;AAGrB,yCAAgB,cAAc,CAC5B,EAAC,QAAQ,EAAC,QAAQ,CAAC,gBAAgB,EAAC,EACpC,IAAI,CAAC,gBAAgB,EACrB,UAAC,eAAe,EAAE,KAAK;eAAK,eAAe,CAAC,GAAG,CAAC,KAAK,CAAC;OAAA,CACvD,CAAC;AACF,cAAQ,CAAC,WAAW,GAAG,QAAQ,CAAC,YAAY,CAAC;;AAE7C,aAAO,QAAQ,CAAC;KACjB;;;WAeM,iBAAC,OAAO,EAAsD;UAApD,GAAG,yDAAG,IAAI;UAAC,QAAQ,yDAAG,IAAI;UAAC,kBAAkB,yDAAC,IAAI;;AACjE,aAAO,CAAC,SAAS,CAAC,MAAM,CAAC,WAAW,CAAC,CAAC;;AAEtC,UAAG,CAAC,kBAAkB,EAAC;AACrB,YAAI,kBAAkB,GAAG,QAAQ,CAAC,sBAAsB,EAAE,CAAC;AAC3D,YAAI,CAAC,GAAG,QAAQ,CAAC,aAAa,CAAC,KAAK,CAAC,CAAC;AACtC,SAAC,CAAC,SAAS,GAAG,OAAO,CAAC,SAAS,CAAC;AAChC,0BAAkB,CAAC,WAAW,CAAC,CAAC,CAAC,CAAC;OACnC;AACD,UAAI,IAAI,GAAG,IAAI,CAAC,YAAY,CAAC,OAAO,CAAC,kBAAkB,EAAE,IAAI,CAAC,SAAS,CAAC,CAAC,MAAM,CAAC,IAAI,CAAC,SAAS,EAAE,GAAG,CAAC,CAAC;;AAErG,UAAG,CAAC,QAAQ,EAAE,QAAQ,GAAG,+BAAa,OAAO,EAAE,IAAI,CAAC,CAAC;;AAErD,cAAQ,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC;AACnB,cAAQ,CAAC,QAAQ,EAAE,CAAC;AACpB,aAAO,QAAQ,CAAC;KACjB;;;WAYwB,mCAAC,OAAO,EAAC,WAAW,EAAC,GAAG,EAAE;AACjD,iBAAW,CAAC,QAAQ,GAAG,WAAW,CAAC,QAAQ,IAAG,+BAAa,OAAO,EAAE,IAAI,EAAC,GAAG,CAAC,CAAC;AAC9E,aAAO,IAAI,CAAC,kBAAkB,CAAC,GAAG,EAAC,WAAW,CAAC,CAAC;KACjD;;;WAUyB,oCAAC,SAAS,EAAC,WAAW,EAAC,GAAG,EAAE;AAGpD,UAAI,OAAO,GAAG,SAAS,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC;;AAErC,UAAI,QAAQ,GAAG,OAAO,CAAC,eAAe,CAAC;;AAEvC,aAAO,CAAC,SAAS,GAAG,EAAE,CAAC;;AAGvB,UAAG,CAAC,QAAQ,EAAE,OAAO;AACrB,UAAI,QAAQ,GAAG,SAAS,CAAC,GAAG,4BAAU,CAAC;;AAEvC,iBAAW,CAAC,QAAQ,GAAG,QAAQ,CAAC;AAChC,iBAAW,CAAC,SAAS,GAAG,QAAQ,CAAC;AACjC,UAAI,OAAO,GAAG,GAAG,IAAE,SAAS,CAAC,gBAAgB,CAAC;AAC9C,iBAAW,CAAC,gBAAgB,GAAG,OAAO,CAAC;;AAEvC,aAAO,IAAI,CAAC,kBAAkB,CAAC,OAAO,EAAC,WAAW,CAAC,CAAC,IAAI,CAAC,UAAA,WAAW,EAAE;AACpE,gBAAQ,CAAC,QAAQ,CAAC,WAAW,GAAG,WAAW,CAAC;AAC5C,gBAAQ,CAAC,IAAI,CAAC,OAAO,CAAC,CAAA;OACvB,CAAC,CAAC;KACJ;;;WAUO,kBAAC,GAAG,EAAC;AACX,aAAO,IAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,GAAG,CAAC,CAAC;KAClC;;;WAQc,yBAAC,IAAI,EAAC;AACnB,aAAO,IAAI,CAAC,UAAU,CAAC,eAAe,CAAC,IAAI,CAAC,CAAC;KAC9C;;;WASW,sBAAC,kBAAkB,EAAE,kBAAkB,EAAC;;;AAClD,aAAO,mBAAmB,CAAC,IAAI,CAAC,MAAM,EAAE,kBAAkB,CAAC,CAAC,IAAI,CAAC,UAAA,iBAAiB,EAAI;AACpF,YAAG,iBAAiB,CAAC,OAAO,EAAC;AAC3B,iBAAO,iBAAiB,CAAC,OAAO,CAAC;SAClC;;AAED,eAAO,MAAK,UAAU,CAAC,qBAAqB,CAAC,iBAAiB,EAAE,kBAAkB,CAAC,CAAC,IAAI,CAAC,UAAA,SAAS,EAAI;AACpG,cAAG,iBAAiB,CAAC,OAAO,EAAC;AAC3B,mBAAO,iBAAiB,CAAC,OAAO,CAAC;WAClC;;AAED,2BAAiB,CAAC,YAAY,CAAC,SAAS,CAAC,CAAC;;AAE1C,iBAAO,iBAAiB,CAAC;SAC1B,CAAC,CAAC;OACJ,CAAC,CAAC;KACJ;;;WAQK,gBAAC,QAAQ,EAAC;;;AACd,UAAI,KAAK,GAAG,IAAI,CAAC,MAAM,CAAC,cAAc,CAAC,QAAQ,CAAC,CAAC;AACjD,UAAG,CAAC,KAAK,EAAC;AACR,eAAO,IAAI,CAAC,UAAU,CAAC,mBAAmB,CAAC,CAAC,QAAQ,CAAC,EAAE,EAAE,EAAE,IAAI,CAAC,SAAS,CAAC,CAAC,IAAI,CAAC,UAAA,SAAS,EAAE;AACzF,iBAAO,OAAK,UAAU,CAAC,uBAAuB,CAAC,QAAQ,CAAC,CAAC;SAC1D,CAAC,CAAC;OACJ,MAAI;AACH,eAAO,OAAO,CAAC,OAAO,CAAC,KAAK,CAAC,CAAC;OAC/B;KACF;;;WAQiB,4BAAC,GAAG,EAAE,WAAW,EAAC;;AAElC,iBAAW,CAAC,SAAS,GAAG,WAAW,CAAC,SAAS,IAAE,GAAG,CAAC,SAAS,IAAE,IAAI,CAAC,SAAS,CAAC;AAC7E,iBAAW,CAAC,gBAAgB,GAAG,WAAW,CAAC,gBAAgB,IAAE,GAAG,IAAE,IAAI,CAAC,gBAAgB,CAAC;AACxF,iBAAW,CAAC,QAAQ,GAAG,WAAW,CAAC,QAAQ,IAAE,GAAG,CAAC,QAAQ,IAAE,IAAI,CAAC,QAAQ,CAAC;AACzE,iBAAW,CAAC,aAAa,GAAG,WAAW,CAAC,aAAa,IAAE,GAAG,CAAC,aAAa,IAAE,IAAI,CAAC,aAAa,CAAC;AAC7F,iBAAW,CAAC,eAAe,GAAG,WAAW,CAAC,eAAe,IAAE,GAAG,CAAC,eAAe,IAAE,IAAI,CAAC,eAAe,CAAC;;AAErG,aAAO,IAAI,CAAC,iBAAiB,CAAC,OAAO,CAAC,WAAW,CAAC,CAAC,IAAI,CAAC,UAAA,IAAI,EAAI;AAC9D,WAAG,CAAC,eAAe,GAAG,IAAI,CAAC;AAC3B,WAAG,CAAC,gBAAgB,GAAG,IAAI,GAAG,IAAI,CAAC,gBAAgB,GAAG,IAAI,CAAC;OAC5D,CAAC,CAAC;KACJ;;;SAzSU,QAAQ;;;;;AA6SrB,SAAS,mBAAmB,CAAC,MAAM,EAAE,kBAAkB,EAAC;AACtD,MAAG,kBAAkB,gDAAiC,EAAC;AACrD,WAAO,OAAO,CAAC,OAAO,CAAC,kBAAkB,CAAC,CAAC;GAC5C;;AAED,SAAO,MAAM,CAAC,YAAY,CAAC,kBAAkB,CAAC,CAAC;CAChD","file":"index.js","sourceRoot":"/source/","sourcesContent":["import {ViewCompiler,CompositionEngine,ViewResources,ViewSlot,ViewEngine,Container} from 'aurelia-framework';\r\nimport {DefaultLoader} from 'aurelia-loader-default';\r\nimport {TemplateRegistryEntry} from 'aurelia-loader';\r\nimport {ContentSelector} from 'aurelia-templating';\r\n\r\n/**\r\n * Compiler service\r\n *\r\n * compiles an HTML element with aurelia\r\n */\r\nexport class Compiler {\r\n  static inject() {return [ViewCompiler, CompositionEngine,ViewEngine,ViewResources,Container,DefaultLoader]}\r\n  constructor(viewCompiler, compositionEngine,viewEngine, resources, container,loader) {\r\n    this.viewCompiler = viewCompiler;\r\n    this.viewEngine = viewEngine;\r\n    this.compositionEngine = compositionEngine;\r\n    this.resources = resources;\r\n    this.container = container;\r\n    this.loader = loader;\r\n  }\r\n\r\n  /**\r\n   * Loads in a new view for a VM and swaps it with the current view in the viewslot.\r\n   *\r\n   * The transormer receives an element and should return a string.\r\n   */\r\n  swapView(container,view,transformer){\r\n\r\n    let element = container.get(Element);\r\n    let behavior = element.primaryBehavior;\r\n\r\n    //store the original content in a document fragment\r\n    if(!behavior.originalFragment) {\r\n      var odata = element.innerHTML;\r\n      if(transformer) odata = transformer(element,element.innerHTML);\r\n      behavior.originalFragment = this.createFragment(odata);\r\n      //var orignalViewFactory = behavior.behavior.originalViewFactory = this.viewCompiler.compile(behavior.originalFragment, resources);\r\n      //behavior.originalView = orignalViewFactory.create(container,behavior.executionContext);\r\n    }\r\n\r\n    return this.loadTemplate(view).then(entry=>{\r\n      let template = entry.template;\r\n\r\n      var data = \"\";\r\n      for(var i = 0, l = template.content.children.length; i < l; i++){\r\n        var child = template.content.children[i];\r\n        if(child) data += child.outerHTML;\r\n      }\r\n\r\n      if(transformer) data = transformer(element,data);\r\n\r\n      //apply the template , clone the nodes as this is a template that is potentially used by many VMs\r\n      element.innerHTML = data;\r\n\r\n      return behavior;\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Create a fragment from an HTMLElement or String\r\n   *\r\n   * @param element {HTMLElement|String}\r\n   * @return {DocumentFragment}\r\n   */\r\n  createFragment(element){\r\n    //create a new fragment from the current content to pass to the viewCompiler\r\n    var fragment = document.createDocumentFragment();\r\n\r\n    var c = document.createElement(\"div\");\r\n    c.innerHTML = (element instanceof HTMLElement)? element.innerHTML : element;\r\n\r\n    var currentChild = c.firstChild, nextSibling;\r\n    while(currentChild){\r\n      nextSibling = currentChild.nextSibling;\r\n      switch(currentChild.nodeType){\r\n        case 1:\r\n          fragment.appendChild(currentChild);\r\n          break;\r\n      }\r\n      currentChild = nextSibling;\r\n    }\r\n\r\n    return fragment;\r\n  }\r\n\r\n  /**\r\n   * Create a new View from an element's innerHTML and add swap it with current viewslot contents.\r\n   *\r\n   * @param container {Container}     DI container of the VM\r\n   * @param ctx {executionContext}    the execution context to bind to (will use the behavior's execution context by default)\r\n   *\r\n   * @return {BehaviorInstance}   The primary behavior associated with the element\r\n   */\r\n  processBehavior(container,ctx){\r\n    //get current element\r\n    var element = container.get(Element);\r\n\r\n    var behavior = element.primaryBehavior;\r\n\r\n    //skip if element doesn't have a behavior\r\n    if(!behavior) return;\r\n    //skip if element already has a viewFactory\r\n    if(behavior.viewFactory) return;\r\n\r\n    behavior.isAttached = false;\r\n\r\n    //get associated viewslot and resources\r\n    var viewSlot = container.get(ViewSlot);\r\n    var resources = container.get(ViewResources);\r\n\r\n    //var viewFactory = behavior.behavior.viewFactory;\r\n\r\n    //create a new viewFactory for the current element contents\r\n    var fragment = this.createFragment(element);\r\n\r\n    //clear targets in the current template\r\n    var targets = fragment.querySelectorAll('.au-target');\r\n    for(var i = 0, l = targets.length; i < l; i++){\r\n      var target = targets[i];\r\n      target.classList.remove('au-target');\r\n    }\r\n\r\n    //create a new ViewFactory and add it to the element's behavior\r\n    var viewFactory = behavior.behavior.viewFactory = this.viewCompiler.compile(fragment, resources);\r\n\r\n    //empty the current contents\r\n    element.innerHTML = \"\";\r\n\r\n    //create a view from the template and add it to the viewslot\r\n    var view = viewFactory.create(container,ctx||behavior.executionContext);\r\n    viewSlot.add(view);\r\n    viewSlot.attached();\r\n\r\n    //add view to the behavior\r\n    behavior.view = view;\r\n\r\n    //process contentSelectors\r\n    ContentSelector.applySelectors(\r\n      {fragment:behavior.originalFragment},\r\n      view.contentSelectors,\r\n      (contentSelector, group) => contentSelector.add(group)\r\n    );\r\n    behavior.contentView = behavior.originalView;\r\n\r\n    return behavior;\r\n  }\r\n\r\n  /**\r\n   * Compile an element\r\n   * the element should be available in the main resource registry or\r\n   * in the registry of the execution context passed as the second parameter.\r\n   *\r\n   * @param element {HTMLElement}     element to compile\r\n   * @param ctx {Object}              execution context\r\n   * @param viewSlot {ViewSlot}       viewslot to add the view to (if null a new one will be created)\r\n   * @param templateOrFragment {HTMLTemplateElement|DocumentFragment}\r\n   *        specify what content to use with the element (if null the element's content will be used)\r\n   *\r\n   * @returns {ViewSlot}\r\n   */\r\n  compile(element, ctx = null,viewSlot = null,templateOrFragment=null) {\r\n    element.classList.remove('au-target');\r\n\r\n    if(!templateOrFragment){\r\n      var templateOrFragment = document.createDocumentFragment();\r\n      var c = document.createElement(\"div\");\r\n      c.innerHTML = element.innerHTML;\r\n      templateOrFragment.appendChild(c);\r\n    }\r\n    var view = this.viewCompiler.compile(templateOrFragment, this.resources).create(this.container, ctx);\r\n\r\n    if(!viewSlot) viewSlot = new ViewSlot(element, true);\r\n\r\n    viewSlot.add(view);\r\n    viewSlot.attached();\r\n    return viewSlot;\r\n  }\r\n\r\n  //------------------ Composing instructions\r\n\r\n  /**\r\n   * compose an alement with a new instruction\r\n   *\r\n   * @param element         an HTMLElement where the instuction will be added to.\r\n   * @param instruction     the instruction to process\r\n   * @param ctx             an exectution context\r\n   * @returns {*}\r\n   */\r\n  composeElementInstruction(element,instruction,ctx) {\r\n    instruction.viewSlot = instruction.viewSlot ||new ViewSlot(element, true,ctx);\r\n    return this.processInstruction(ctx,instruction);\r\n  }\r\n\r\n  /**\r\n   * compose an existing behaviour with a new instruction\r\n   *\r\n   * @param container       the DI container of the behavior (the instruction will be added to it's element)\r\n   * @param instruction     the instruction to process\r\n   * @param ctx             the exectution context\r\n   * @returns {*}\r\n   */\r\n  composeBehaviorInstruction(container,instruction,ctx) {\r\n\r\n    //get current element\r\n    var element = container.get(Element);\r\n\r\n    var behavior = element.primaryBehavior;\r\n\r\n    element.innerHTML = \"\";\r\n\r\n    //skip if element doesn't have a behavior\r\n    if(!behavior) return;\r\n    var viewSlot = container.get(ViewSlot);\r\n\r\n    instruction.viewSlot = viewSlot;\r\n    instruction.viewModel = behavior;\r\n    var context = ctx||container.executionContext;\r\n    instruction.executionContext = context;\r\n\r\n    return this.processInstruction(context,instruction).then(viewFactory=>{\r\n      behavior.behavior.viewFactory = viewFactory;\r\n      viewSlot.bind(context)\r\n    });\r\n  }\r\n\r\n  //------------------ Loading helpers\r\n\r\n  /**\r\n   * Load a moduleId as plain text\r\n   *\r\n   * @param url      path to a view file\r\n   * @returns {String}\r\n   */\r\n  loadText(url){\r\n    return this.loader.loadText(url);\r\n  }\r\n\r\n  /**\r\n   * Load a moduleId as a view factory\r\n   *\r\n   * @param view      path to a view file\r\n   * @returns {ViewFactory}\r\n   */\r\n  loadViewFactory(view){\r\n    return this.viewEngine.loadViewFactory(view);\r\n  }\r\n\r\n  /**\r\n   * Load a template and return a view registry entry\r\n   *\r\n   * @param urlOrRegistryEntry\r\n   * @param associatedModuleId\r\n   * @returns {viewRegistryEntry}\r\n   */\r\n  loadTemplate(urlOrRegistryEntry, associatedModuleId){\r\n    return ensureRegistryEntry(this.loader, urlOrRegistryEntry).then(viewRegistryEntry => {\r\n      if(viewRegistryEntry.isReady){\r\n        return viewRegistryEntry.factory;\r\n      }\r\n\r\n      return this.viewEngine.loadTemplateResources(viewRegistryEntry, associatedModuleId).then(resources => {\r\n        if(viewRegistryEntry.isReady){\r\n          return viewRegistryEntry.factory;\r\n        }\r\n\r\n        viewRegistryEntry.setResources(resources);\r\n\r\n        return viewRegistryEntry;\r\n      });\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Loads in View and View Model resources and returns the registry entry for the VM\r\n   *\r\n   * @param moduleId\r\n   * @returns {Promise} return a registry entry\r\n   */\r\n  loadVM(moduleId){\r\n    var entry = this.loader.moduleRegistry[moduleId];\r\n    if(!entry){\r\n      return this.viewEngine.importViewResources([moduleId], [], this.resources).then(resources=>{\r\n        return this.viewEngine.importViewModelResource(moduleId);\r\n      });\r\n    }else{\r\n      return Promise.resolve(entry);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Process an instruction\r\n   * @param ctx\r\n   * @param instruction\r\n   * @returns {*}\r\n   */\r\n  processInstruction(ctx, instruction){\r\n\r\n    instruction.container = instruction.container||ctx.container||this.container;\r\n    instruction.executionContext = instruction.executionContext||ctx||this.executionContext;\r\n    instruction.viewSlot = instruction.viewSlot||ctx.viewSlot||this.viewSlot;\r\n    instruction.viewResources = instruction.viewResources||ctx.viewResources||this.viewResources;\r\n    instruction.currentBehavior = instruction.currentBehavior||ctx.currentBehavior||this.currentBehavior;\r\n\r\n    return this.compositionEngine.compose(instruction).then(next => {\r\n      ctx.currentBehavior = next;\r\n      ctx.currentViewModel = next ? next.executionContext : null;\r\n    });\r\n  }\r\n\r\n}\r\n\r\nfunction ensureRegistryEntry(loader, urlOrRegistryEntry){\r\n  if(urlOrRegistryEntry instanceof TemplateRegistryEntry){\r\n    return Promise.resolve(urlOrRegistryEntry);\r\n  }\r\n\r\n  return loader.loadTemplate(urlOrRegistryEntry);\r\n}\r\n"]}